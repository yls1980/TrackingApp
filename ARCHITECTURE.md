# ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° XTrack

Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°Ğ¼Ğ¸ Ğ¸ ÑÑ…ĞµĞ¼Ğ°Ğ¼Ğ¸.

---

## ğŸ“ ĞĞ±Ñ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

### Clean Architecture + MVVM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PRESENTATION LAYER                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Screens   â”‚â”€â”€â”€â–ºâ”‚  ViewModels â”‚â—„â”€â”€â–ºâ”‚    Theme    â”‚      â”‚
â”‚  â”‚  (Compose)  â”‚    â”‚   (State)   â”‚    â”‚  (Material) â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                   â–²                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Events / State
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â–¼         DOMAIN LAYER                      â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚         â”‚   Repositories   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚         â”‚   (Interfaces)   â”‚              â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                  â”‚
â”‚                   â”‚                       â”‚                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                  â”‚
â”‚         â”‚    Use Cases     â”‚              â”‚                  â”‚
â”‚         â”‚  (Business Logic)â”‚              â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                       â”‚
                    â”‚ Data Flow             â”‚
                    â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA LAYER             â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Database   â”‚  â”‚   Parsers    â”‚  â”‚  Services    â”‚       â”‚
â”‚  â”‚    (Room)    â”‚  â”‚ (GPX/JSON)   â”‚  â”‚  (Location)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                 â”‚                  â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚     DAO      â”‚  â”‚  Generators  â”‚  â”‚   Sensors    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1. Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ GPS-Ñ‚Ñ€ĞµĞºĞ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚  (UI Layer) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Click "Start"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MainViewModel  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. startRecording()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TrackRepository     â”‚
â”‚  - insertTrack()     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. Create Track
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TrackDao (Room)    â”‚
â”‚   - insert()         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. Save to DB
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SQLite Database    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 5. Start Service
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LocationTrackingService      â”‚
â”‚ - startForeground()          â”‚
â”‚ - requestLocationUpdates()   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. Request updates
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FusedLocationProvider (GPS)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 7. GPS Location
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LocationCallback             â”‚
â”‚ - onLocationResult()         â”‚
â”‚   â”œâ”€â–º Filter by accuracy     â”‚
â”‚   â”œâ”€â–º Filter by distance     â”‚
â”‚   â””â”€â–º Calculate metrics      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 8. Valid point
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Network Check                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â–º Yes (network available)
       â”‚   â–¼
       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚ TrackPointDao        â”‚
       â”‚   â”‚ - insert()           â”‚
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â–º No (offline)
           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ BufferedTrackPointDao    â”‚
           â”‚ - insertBuffered()       â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 9. Update UI
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flow<Track>                  â”‚
â”‚ - collectAsState()           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 10. Recompose
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MainScreen (Compose)         â”‚
â”‚ - Updated metrics            â”‚
â”‚ - Updated polyline on map    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±ÑƒÑ„ĞµÑ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚Ğ¾Ñ‡ĞµĞº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NetworkCallback              â”‚
â”‚ - onAvailable()              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Network restored
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BufferedPointsSyncService    â”‚
â”‚ - syncBufferedPoints()       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Get unsynced
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BufferedTrackPointRepository â”‚
â”‚ - getUnsyncedPoints()        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. List<BufferedPoint>
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ For each buffered point      â”‚
â”‚   â”œâ”€â–º Convert to TrackPoint  â”‚
â”‚   â”œâ”€â–º Insert to track_points â”‚
â”‚   â””â”€â–º Mark as synced         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. Update metrics
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TrackRepository              â”‚
â”‚ - updateTrackMetrics()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ñ‚Ñ€ĞµĞºĞ° Ğ² GPX

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User           â”‚
â”‚  - Click Export â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. exportTrack()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TrackDetailViewModel         â”‚
â”‚ - exportTrack(GPX)           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Get data
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TrackRepository              â”‚
â”‚ - getTrackById()             â”‚
â”‚ - getTrackPoints()           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. Track + Points
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GpxGenerator                 â”‚
â”‚ - generate()                 â”‚
â”‚   â”œâ”€â–º Create metadata        â”‚
â”‚   â”œâ”€â–º Create track segment   â”‚
â”‚   â””â”€â–º Add trackpoints        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. GPX XML String
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File I/O                     â”‚
â”‚ - Write to file              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. File created
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FileProvider                 â”‚
â”‚ - getUriForFile()            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. Content URI
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Share Intent                 â”‚
â”‚ - ACTION_SEND                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ƒï¸ Database Architecture

### Entity Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATABASE SCHEMA                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      tracks         â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK  id: String      â”‚
â”‚     name: String    â”‚
â”‚     startedAt       â”‚
â”‚     endedAt         â”‚
â”‚     distanceMeters  â”‚
â”‚     durationSec     â”‚
â”‚     elevationGain   â”‚
â”‚     gpxPath         â”‚
â”‚     geojsonPath     â”‚
â”‚     isRecording     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1:N
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                    â”‚                      â”‚
    â–¼                                    â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   track_points      â”‚    â”‚     map_notes        â”‚  â”‚ buffered_points     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK  id: String      â”‚    â”‚ PK  id: String       â”‚  â”‚ PK  id: String      â”‚
â”‚ FK  trackId         â”‚    â”‚ FK  trackId          â”‚  â”‚ FK  trackId         â”‚
â”‚     timestamp       â”‚    â”‚     latitude         â”‚  â”‚     timestamp       â”‚
â”‚     latitude        â”‚    â”‚     longitude        â”‚  â”‚     latitude        â”‚
â”‚     longitude       â”‚    â”‚     title            â”‚  â”‚     longitude       â”‚
â”‚     altitude        â”‚    â”‚     description      â”‚  â”‚     altitude        â”‚
â”‚     speed           â”‚    â”‚     timestamp        â”‚  â”‚     speed           â”‚
â”‚     bearing         â”‚    â”‚     noteType         â”‚  â”‚     bearing         â”‚
â”‚     accuracy        â”‚    â”‚     mediaPath        â”‚  â”‚     accuracy        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     mediaType        â”‚  â”‚     isSynced        â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     createdAt       â”‚
                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   app_settings      â”‚    â”‚   last_location      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK  id: Int (1)     â”‚    â”‚ PK  id: Int (1)      â”‚
â”‚     locationAccuracyâ”‚    â”‚     latitude         â”‚
â”‚     intervalMs      â”‚    â”‚     longitude        â”‚
â”‚     minDistance     â”‚    â”‚     timestamp        â”‚
â”‚     accuracyThresh. â”‚    â”‚     accuracy         â”‚
â”‚     autoPauseEnabl. â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚     autoPauseSpeed  â”‚
â”‚     autoPauseDurat. â”‚    Singleton tables
â”‚     exportFormat    â”‚    (always 1 row)
â”‚     appExitState    â”‚
â”‚     distNotifInterv.â”‚
â”‚     distNotifEnabl. â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Migrations Timeline

```
v1 (Initial)
  â”œâ”€ tracks
  â”œâ”€ track_points
  â””â”€ app_settings

v2 (Map Notes)
  â”œâ”€ Added: map_notes table
  â””â”€ Purpose: Store user notes on map

v3 (Last Location)
  â”œâ”€ Added: last_location table
  â””â”€ Purpose: Remember last known position

v4 (Exit State)
  â”œâ”€ Added: wasRecordingOnExit field
  â””â”€ Purpose: Restore recording state on app restart

v5 (Buffering)
  â”œâ”€ Added: buffered_track_points table
  â””â”€ Purpose: Offline point buffering

v6 (Distance Notifications)
  â”œâ”€ Added: distanceNotificationIntervalMeters
  â”œâ”€ Added: distanceNotificationsEnabled
  â””â”€ Purpose: Periodic distance notifications

v7 (Data Integrity)
  â”œâ”€ Fixed: app_settings table corruption
  â””â”€ Purpose: Data integrity improvements

v8 (Elevation)
  â”œâ”€ Added: elevationGainMeters field
  â””â”€ Purpose: Track elevation gain

v9 (Schema Update)
  â””â”€ Purpose: Internal schema hash update

v10 (Type Converters)
  â”œâ”€ Added: TypeConverters for enums
  â””â”€ Purpose: Proper enum serialization

v11 (Exit State Enum) â† Current
  â”œâ”€ Changed: wasRecordingOnExit â†’ appExitState
  â””â”€ Purpose: Better state management
```

---

## ğŸ”Œ Dependency Injection (Hilt)

### Component Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      SingletonComponent                â”‚
â”‚  (Application Lifecycle)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DatabaseModule                   â”‚ â”‚
â”‚  â”‚ - TrackingDatabase               â”‚ â”‚
â”‚  â”‚ - All DAOs                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ParserModule                     â”‚ â”‚
â”‚  â”‚ - GpxParser                      â”‚ â”‚
â”‚  â”‚ - GpxGenerator                   â”‚ â”‚
â”‚  â”‚ - GeoJsonParser                  â”‚ â”‚
â”‚  â”‚ - GeoJsonGenerator               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Repositories                     â”‚ â”‚
â”‚  â”‚ - TrackRepository                â”‚ â”‚
â”‚  â”‚ - SettingsRepository             â”‚ â”‚
â”‚  â”‚ - MapNoteRepository              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         â”‚
    â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ViewModelComp.  â”‚   â”‚ ServiceComponent â”‚
â”‚  (ViewModel)    â”‚   â”‚  (Service)       â”‚
â”‚  - ViewModels   â”‚   â”‚  - Services      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Injection Graph

```
@HiltAndroidApp
XTrackApplication
    â”‚
    â”œâ”€â–º @AndroidEntryPoint
    â”‚   MainActivity
    â”‚       â”‚
    â”‚       â””â”€â–º @HiltViewModel
    â”‚           ViewModels (injected)
    â”‚               â”‚
    â”‚               â””â”€â–º Repositories (injected)
    â”‚                       â”‚
    â”‚                       â””â”€â–º DAOs (injected)
    â”‚
    â””â”€â–º @AndroidEntryPoint
        LocationTrackingService
            â”‚
            â””â”€â–º Repositories (injected)
                    â”‚
                    â””â”€â–º DAOs (injected)
```

---

## ğŸ­ State Management

### ViewModel State Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ViewModel                             â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚              Private State                          â”‚     â”‚
â”‚  â”‚  _uiState: MutableStateFlow<UiState>               â”‚     â”‚
â”‚  â”‚  _events: MutableSharedFlow<Event>                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚ expose as                             â”‚
â”‚                       â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚              Public State                           â”‚     â”‚
â”‚  â”‚  uiState: StateFlow<UiState>                       â”‚     â”‚
â”‚  â”‚  events: SharedFlow<Event>                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ collect in Compose
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Composable                             â”‚
â”‚                                                               â”‚
â”‚  val uiState by viewModel.uiState.collectAsState()           â”‚
â”‚                                                               â”‚
â”‚  LaunchedEffect(Unit) {                                       â”‚
â”‚      viewModel.events.collect { event ->                      â”‚
â”‚          when (event) {                                       â”‚
â”‚              is Event.ShowSnackbar -> ...                     â”‚
â”‚              is Event.Navigate -> ...                         â”‚
â”‚          }                                                    â”‚
â”‚      }                                                        â”‚
â”‚  }                                                            â”‚
â”‚                                                               â”‚
â”‚  // UI based on uiState                                       â”‚
â”‚  if (uiState.isLoading) { ... }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State Hoisting Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Screen (Stateful)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ViewModel                                             â”‚  â”‚
â”‚  â”‚ - State management                                    â”‚  â”‚
â”‚  â”‚ - Business logic                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚ provides                                    â”‚
â”‚                â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Screen Composable                                     â”‚  â”‚
â”‚  â”‚ - Observes state                                      â”‚  â”‚
â”‚  â”‚ - Delegates events to ViewModel                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ delegates to
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Content Composable (Stateless)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ @Composable                                           â”‚  â”‚
â”‚  â”‚ fun Content(                                          â”‚  â”‚
â”‚  â”‚     state: UiState,                                   â”‚  â”‚
â”‚  â”‚     onEvent: (Event) -> Unit                          â”‚  â”‚
â”‚  â”‚ ) {                                                   â”‚  â”‚
â”‚  â”‚     // Pure UI based on state                         â”‚  â”‚
â”‚  â”‚     // Calls onEvent for user actions                 â”‚  â”‚
â”‚  â”‚ }                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  Benefits:                                                   â”‚
â”‚  âœ“ Testable (pure function)                                 â”‚
â”‚  âœ“ Reusable                                                 â”‚
â”‚  âœ“ Preview-able                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ºï¸ Navigation Architecture

### Navigation Graph Structure

```
NavHost (startDestination = "main")
    â”‚
    â”œâ”€â–º main (MainScreen)
    â”‚   â”œâ”€â–º Navigate to: tracks, settings, add_note
    â”‚   â””â”€â–º Features: Map, Recording, Metrics
    â”‚
    â”œâ”€â–º tracks (TracksListScreen)
    â”‚   â”œâ”€â–º Navigate to: track_detail, import_track
    â”‚   â””â”€â–º Features: List, Search, Delete, Export
    â”‚
    â”œâ”€â–º track_detail/{trackId} (TrackDetailScreen)
    â”‚   â”œâ”€â–º Navigate to: [popBackStack]
    â”‚   â””â”€â–º Features: Map, Statistics, Export, Delete
    â”‚
    â”œâ”€â–º import_track (ImportTrackScreen)
    â”‚   â”œâ”€â–º Navigate to: [popBackStack]
    â”‚   â””â”€â–º Features: File picker, Preview, Import
    â”‚
    â”œâ”€â–º settings (SettingsScreen)
    â”‚   â”œâ”€â–º Navigate to: error_logs, notes_list, notes_map
    â”‚   â””â”€â–º Features: GPS settings, Export, Diagnostics
    â”‚
    â”œâ”€â–º error_logs (ErrorLogScreen)
    â”‚   â”œâ”€â–º Navigate to: [popBackStack]
    â”‚   â””â”€â–º Features: View logs, Export, Clear
    â”‚
    â”œâ”€â–º notes_list (NotesListScreen)
    â”‚   â”œâ”€â–º Navigate to: note_detail, notes_map_note
    â”‚   â””â”€â–º Features: List, Filter, Delete
    â”‚
    â”œâ”€â–º notes_map (NotesMapScreen)
    â”‚   â”œâ”€â–º Navigate to: [popBackStack]
    â”‚   â””â”€â–º Features: Map with notes, Cluster
    â”‚
    â”œâ”€â–º notes_map_note/{noteId} (NotesMapScreen)
    â”‚   â”œâ”€â–º Navigate to: [popBackStack]
    â”‚   â””â”€â–º Features: Map centered on note
    â”‚
    â”œâ”€â–º note_detail/{noteId} (NoteDetailScreen)
    â”‚   â”œâ”€â–º Navigate to: notes_map_note, [popBackStack]
    â”‚   â””â”€â–º Features: View, Edit, Delete, Map
    â”‚
    â””â”€â–º add_note/{lat}/{lng} (AddNoteScreen)
        â”œâ”€â–º Navigate to: [popBackStack]
        â””â”€â–º Features: Text, Photo, Video
```

### Navigation Flow Example: View Track Details

```
User Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MainScreen  â”‚
â”‚  (main)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Tap "View Tracks"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TracksListScreenâ”‚
â”‚   (tracks)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Tap Track Item
       â”‚ navController.navigate("track_detail/$trackId")
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TrackDetailScreen   â”‚
â”‚ (track_detail/{id}) â”‚
â”‚                     â”‚
â”‚ - Extracts trackId  â”‚
â”‚   from arguments    â”‚
â”‚ - ViewModel loads   â”‚
â”‚   track data        â”‚
â”‚ - Shows map + stats â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Tap Back
       â”‚ navController.popBackStack()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TracksListScreenâ”‚
â”‚   (restored)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”” Service Architecture

### LocationTrackingService Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Service Lifecycle                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

onCreate()
    â”‚
    â”œâ”€â–º createNotificationChannel()
    â”œâ”€â–º initialize FusedLocationProviderClient
    â”œâ”€â–º setup LocationCallback
    â””â”€â–º startNetworkMonitoring()

onStartCommand(intent, flags, startId)
    â”‚
    â”œâ”€â–º startForeground(NOTIFICATION_ID, notification)
    â”‚   â””â”€â–º (MUST be called within 5 seconds)
    â”‚
    â””â”€â–º when (intent.action)
        â”‚
        â”œâ”€â–º ACTION_START_RECORDING
        â”‚   â”œâ”€â–º load settings
        â”‚   â”œâ”€â–º requestLocationUpdates()
        â”‚   â””â”€â–º update notification
        â”‚
        â”œâ”€â–º ACTION_STOP_RECORDING
        â”‚   â”œâ”€â–º removeLocationUpdates()
        â”‚   â”œâ”€â–º finalize track
        â”‚   â”œâ”€â–º generate GPX/GeoJSON (optional)
        â”‚   â”œâ”€â–º stopForeground()
        â”‚   â””â”€â–º stopSelf()
        â”‚
        â”œâ”€â–º ACTION_PAUSE_RECORDING
        â”‚   â”œâ”€â–º removeLocationUpdates()
        â”‚   â””â”€â–º update notification
        â”‚
        â”œâ”€â–º ACTION_RESUME_RECORDING
        â”‚   â”œâ”€â–º requestLocationUpdates()
        â”‚   â””â”€â–º update notification
        â”‚
        â””â”€â–º ACTION_EMERGENCY_STOP
            â”œâ”€â–º removeLocationUpdates()
            â”œâ”€â–º log error
            â””â”€â–º stopSelf()

onDestroy()
    â”‚
    â”œâ”€â–º removeLocationUpdates()
    â”œâ”€â–º stopNetworkMonitoring()
    â””â”€â–º cleanup resources

return START_STICKY
```

### Location Update Flow

```
GPS Sensor
    â”‚
    â–¼
FusedLocationProviderClient
    â”‚ location updates every N ms
    â–¼
LocationCallback.onLocationResult()
    â”‚
    â”œâ”€â–º for each location:
    â”‚   â”‚
    â”‚   â”œâ”€â–º [Filter 1] accuracy < threshold?
    â”‚   â”‚   â”‚  No â†’ discard
    â”‚   â”‚   â”‚  Yes â†“
    â”‚   â”‚
    â”‚   â”œâ”€â–º [Filter 2] distance >= minDistance?
    â”‚   â”‚   â”‚  No â†’ discard
    â”‚   â”‚   â”‚  Yes â†“
    â”‚   â”‚
    â”‚   â”œâ”€â–º [Filter 3] time >= interval?
    â”‚   â”‚   â”‚  No â†’ discard
    â”‚   â”‚   â”‚  Yes â†“
    â”‚   â”‚
    â”‚   â”œâ”€â–º Create TrackPoint
    â”‚   â”‚
    â”‚   â”œâ”€â–º Check network
    â”‚   â”‚   â”œâ”€â–º Online â†’ save to track_points
    â”‚   â”‚   â””â”€â–º Offline â†’ save to buffered_track_points
    â”‚   â”‚
    â”‚   â”œâ”€â–º Update track metrics
    â”‚   â”‚   â”œâ”€â–º totalDistance += calculateDistance()
    â”‚   â”‚   â”œâ”€â–º elevationGain += calculateElevation()
    â”‚   â”‚   â””â”€â–º duration = now - startTime
    â”‚   â”‚
    â”‚   â””â”€â–º Update notification
    â”‚       â””â”€â–º show current metrics
    â”‚
    â””â”€â–º [Auto-Pause Check]
        â”œâ”€â–º speed < autoPauseThreshold?
        â”‚   â””â”€â–º wait autoPauseDuration
        â”‚       â””â”€â–º still slow? â†’ pause()
        â””â”€â–º speed >= autoPauseThreshold?
            â””â”€â–º was paused? â†’ resume()
```

### Foreground Service Notification

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ğŸ—ºï¸ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ñ‚Ñ€ĞµĞºĞ°                           â”‚
â”‚                                                           â”‚
â”‚  ğŸ“ Ğ Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ: 5.2 ĞºĞ¼                                    â”‚
â”‚  â±ï¸  Ğ’Ñ€ĞµĞ¼Ñ: 01:15:30                                      â”‚
â”‚  ğŸš€ Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ: 12.5 ĞºĞ¼/Ñ‡                                   â”‚
â”‚                                                           â”‚
â”‚  [â¸ï¸ ĞŸĞ°ÑƒĞ·Ğ°]  [â¹ï¸ Ğ¡Ñ‚Ğ¾Ğ¿]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

States:
â”œâ”€â–º Recording (ongoing = true, priority = LOW)
â”œâ”€â–º Paused (ongoing = true, priority = MIN)
â””â”€â–º Stopped (notification removed)

Updates:
â”œâ”€â–º Every 5 seconds (while recording)
â”œâ”€â–º Every 1 second (during auto-pause countdown)
â””â”€â–º On distance milestones (if enabled)
```

---

## ğŸ“± UI Component Hierarchy

### MainScreen Component Tree

```
MainScreen (@Composable)
â”‚
â”œâ”€â–º Scaffold
â”‚   â”œâ”€â–º TopAppBar
â”‚   â”‚   â”œâ”€â–º Title: "XTrack"
â”‚   â”‚   â””â”€â–º Actions
â”‚   â”‚       â”œâ”€â–º IconButton (Settings)
â”‚   â”‚       â””â”€â–º IconButton (Tracks)
â”‚   â”‚
â”‚   â””â”€â–º Content
â”‚       â”‚
â”‚       â”œâ”€â–º MapView (Full screen)
â”‚       â”‚   â”œâ”€â–º Yandex MapKit
â”‚       â”‚   â”œâ”€â–º Polyline (current track)
â”‚       â”‚   â”œâ”€â–º Markers (notes)
â”‚       â”‚   â””â”€â–º User location marker
â”‚       â”‚
â”‚       â”œâ”€â–º BottomSheet (Metrics)
â”‚       â”‚   â”œâ”€â–º StatisticsCard (Distance)
â”‚       â”‚   â”œâ”€â–º StatisticsCard (Time)
â”‚       â”‚   â”œâ”€â–º StatisticsCard (Speed)
â”‚       â”‚   â””â”€â–º StatisticsCard (Elevation)
â”‚       â”‚
â”‚       â””â”€â–º FloatingActionButton
â”‚           â”œâ”€â–º State: Not Recording â†’ Green "Start"
â”‚           â”œâ”€â–º State: Recording â†’ Red "Stop"
â”‚           â””â”€â–º State: Paused â†’ Yellow "Resume"
â”‚
â”œâ”€â–º if (showPermissionDialog)
â”‚   â””â”€â–º PermissionDialog
â”‚
â””â”€â–º if (showAddNoteDialog)
    â””â”€â–º AddNoteDialog
```

### Recomposition Optimization

```
Remember & Derivation:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @Composable                                             â”‚
â”‚ fun MainScreen(viewModel: MainViewModel) {              â”‚
â”‚                                                         â”‚
â”‚   // âœ“ Observe state                                   â”‚
â”‚   val uiState by viewModel.uiState.collectAsState()    â”‚
â”‚   val track by viewModel.currentTrack.collectAsState() â”‚
â”‚                                                         â”‚
â”‚   // âœ“ Derived state (doesn't cause extra recomp)      â”‚
â”‚   val formattedDistance = remember(track) {            â”‚
â”‚       LocationUtils.formatDistance(track?.distance)    â”‚
â”‚   }                                                     â”‚
â”‚                                                         â”‚
â”‚   // âœ“ Stable callbacks                                â”‚
â”‚   val onStartClick = remember {                        â”‚
â”‚       { viewModel.startRecording() }                   â”‚
â”‚   }                                                     â”‚
â”‚                                                         â”‚
â”‚   // UI...                                             â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Recomposition Scopes:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Column {                                                â”‚
â”‚   // Scope 1: Only recomposes when title changes       â”‚
â”‚   Text(title)                                           â”‚
â”‚                                                         â”‚
â”‚   // Scope 2: Only recomposes when distance changes    â”‚
â”‚   StatisticsCard(                                       â”‚
â”‚       title = "Distance",                              â”‚
â”‚       value = formattedDistance                        â”‚
â”‚   )                                                     â”‚
â”‚                                                         â”‚
â”‚   // Scope 3: Only recomposes when isRecording changes â”‚
â”‚   Button(                                              â”‚
â”‚       onClick = onStartClick,                          â”‚
â”‚       enabled = !isRecording                           â”‚
â”‚   ) {                                                   â”‚
â”‚       Text(if (isRecording) "Stop" else "Start")       â”‚
â”‚   }                                                     â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security & Privacy

### Data Protection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Storage                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Internal Storage (app-private, encrypted on device)
â”œâ”€â–º /data/data/com.xtrack/
    â”‚
    â”œâ”€â–º databases/
    â”‚   â””â”€â–º tracking_database
    â”‚       â”œâ”€â–º All track data
    â”‚       â”œâ”€â–º Settings
    â”‚       â””â”€â–º Notes
    â”‚
    â”œâ”€â–º files/
    â”‚   â”œâ”€â–º tracks/ (GPX/GeoJSON)
    â”‚   â”œâ”€â–º media/ (photos/videos)
    â”‚   â””â”€â–º logs/ (error logs)
    â”‚
    â””â”€â–º shared_prefs/
        â””â”€â–º (none used - all in Room DB)

External Storage (user-accessible)
â””â”€â–º /Android/data/com.xtrack/
    â””â”€â–º files/export/ (exported files only)
```

### Permission Model

```
Runtime Permissions Flow:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ App Launch                                              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Location Permission                               â”‚
â”‚ â”œâ”€â–º GRANTED â†’ Continue                                  â”‚
â”‚ â””â”€â–º DENIED â†’ Show rationale                             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Taps "Start Recording"                             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request Permissions Sequentially                        â”‚
â”‚ 1. ACCESS_FINE_LOCATION                                 â”‚
â”‚    â”œâ”€â–º GRANTED â†’ Continue                               â”‚
â”‚    â””â”€â–º DENIED â†’ Show error                              â”‚
â”‚                                                         â”‚
â”‚ 2. ACCESS_BACKGROUND_LOCATION (Android 10+)             â”‚
â”‚    â”œâ”€â–º GRANTED â†’ Full functionality                     â”‚
â”‚    â””â”€â–º DENIED â†’ Limited (foreground only)               â”‚
â”‚                                                         â”‚
â”‚ 3. POST_NOTIFICATIONS (Android 13+)                     â”‚
â”‚    â”œâ”€â–º GRANTED â†’ Show notifications                     â”‚
â”‚    â””â”€â–º DENIED â†’ Silent mode                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ Performance Optimizations

### Database Optimizations

```
Indexes:
â”œâ”€â–º tracks.startedAt (for sorting by date)
â”œâ”€â–º tracks.isRecording (for finding active track)
â”œâ”€â–º track_points.trackId (for JOIN queries)
â”œâ”€â–º track_points.timestamp (for time-based queries)
â”œâ”€â–º map_notes.trackId (for filtering by track)
â”œâ”€â–º map_notes.noteType (for filtering by type)
â””â”€â–º buffered_track_points.isSynced (for sync queries)

Query Optimization:
â”œâ”€â–º Use Flow for reactive updates (no polling)
â”œâ”€â–º Pagination for large lists (LazyColumn)
â”œâ”€â–º Limit queries with LIMIT clause
â””â”€â–º Batch inserts for multiple points

Transaction Batching:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @Transaction                                  â”‚
â”‚ suspend fun insertTrackWithPoints(            â”‚
â”‚     track: Track,                             â”‚
â”‚     points: List<TrackPoint>                  â”‚
â”‚ ) {                                           â”‚
â”‚     trackDao.insert(track)                    â”‚
â”‚     points.chunked(100).forEach { chunk ->    â”‚
â”‚         trackPointDao.insertAll(chunk)        â”‚
â”‚     }                                         â”‚
â”‚ }                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Memory Management

```
Lifecycle-Aware Collection:

viewModelScope.launch {
    trackRepository.getActiveTrack()
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5000),
            //       â†‘ Stop collecting 5s after last subscriber
            initialValue = null
        )
}

Benefits:
âœ“ Stops DB queries when UI not visible
âœ“ Cancels coroutines automatically
âœ“ Prevents memory leaks
```

### Location Update Optimization

```
Adaptive Interval:

Moving Fast (> 5 m/s):
â”œâ”€â–º Interval: 1 second
â””â”€â–º High accuracy GPS

Moving Slow (1-5 m/s):
â”œâ”€â–º Interval: 5 seconds
â””â”€â–º Balanced accuracy

Stationary (< 1 m/s):
â”œâ”€â–º Interval: 10 seconds (or auto-pause)
â””â”€â–º Low power mode
```

---

## ğŸ§ª Testing Strategy

### Testing Pyramid

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   E2E   â”‚  (5%)
                    â”‚  Tests  â”‚
                â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”
                â”‚  Integration    â”‚  (15%)
                â”‚     Tests       â”‚
            â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”
            â”‚      Unit Tests         â”‚  (80%)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Unit Tests (Fast, Isolated):
â”œâ”€â–º ViewModels
â”œâ”€â–º Repositories
â”œâ”€â–º Utils (LocationUtils, etc.)
â””â”€â–º Parsers (GPX, GeoJSON)

Integration Tests (Medium):
â”œâ”€â–º Database (DAO tests)
â”œâ”€â–º Repository + Database
â””â”€â–º Service + Repository

E2E Tests (Slow, Full app):
â”œâ”€â–º User flows
â””â”€â–º UI tests (Compose)
```

---

**Ğ’ĞµÑ€ÑĞ¸Ñ:** 1.0  
**ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:** 10 Ğ¾ĞºÑ‚ÑĞ±Ñ€Ñ 2024

